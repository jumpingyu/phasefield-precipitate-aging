\documentclass[10pt]{article}
\usepackage{amsmath,amssymb,siunitx}
\usepackage[letterpaper,top=1.25in,bottom=1.25in,left=1in,right=1in]{geometry}
\usepackage[version=3]{mhchem}

\DeclareMathOperator{\sgn}{sgn}

\pagestyle{plain}
\begin{document}
	I am attempting to model solid-state transformations in Inconel 625 based on a published Inconel 718 model \cite{Zhou2014},
	which is a generalization of the KKS binary model \cite{Kim1999}.
	
	To capture $\delta$, $\mu$, and Laves precipitates in a $\gamma$ matrix, I have chosen Ni--\SI{30}{\percent} Cr--\SI{2}{\percent} Nb as the model system.
	The interdendritic regions in additive manufacturing get enriched to Ni--\SI{31}{\percent} Cr--\SI{13}{\percent} Nb.
	The four-phase three-component model is represented using two composition fields $\left(x_\ce{Cr}, x_\ce{Nb}\right)$
	and three phase fields $\left(\phi_\delta, \phi_\mu, \phi_{\mathrm{Laves}}\right)$.

	The pure phase free energies depend on Gibbs free energy expressions, divided by molar volume to convert from \si{\joule/\mole} to \si{\joule/\cubic\meter}.
	I have used two models for these free energies:
	\begin{enumerate}
		\item Read a CALPHAD database using pycalphad, export C code directly with sympy; or
		\item Parabolic approximations for each phase, $f\approx V_m^{-1}\sum C_j(x_j-x_j^e)^2$.
		      The curvature $C$ for each element $C_j=\left.\frac{1}{2}\frac{\partial^2 f}{\partial {x_j}^2}\right|_{x_j=x_j^e}$, computed from the CALPHAD expression.
		      The equilibrium value for each element $x_j^e$ is taken from the centroid of the phase from a phase diagram computed using the convex hull of CALPHAD free energies.
	\end{enumerate}
	To simplify the model as much as possible while troubleshooting numerics, the parabolic approximation is used in the code.
	Note that Zhou \emph{et al.} \cite{Zhou2014} sets $C_j=C_j^\gamma$ rather than specifying different curvatures for each phase,
	while my code (at the moment) allows each phase its own curvature.\footnote{In the following exposition, $j$ is the index for elements and $i$ the index for phases.
	}
	Comparison of the phase diagrams shows no difference.
	
	In this model, the system composition depends on the pure-phase compositions and phase fractions:
	\begin{align}
		\label{eqn:conscr}
		x_{\ce{Cr}} &= n_\gamma x_\ce{Cr}^\gamma + n_\delta x_\ce{Cr}^\delta + n_\mu x_\ce{Cr}^\mu + n_{\mathrm{L}}x_\ce{Cr}^{\mathrm{L}}\\
		\label{eqn:consnb}
		x_{\ce{Nb}} &= n_\gamma x_\ce{Nb}^\gamma + n_\delta x_\ce{Nb}^\delta + n_\mu x_\ce{Nb}^\mu + n_{\mathrm{L}}x_\ce{Nb}^{\mathrm{L}}
	\end{align}
	Zhou \emph{et al.} \cite{Zhou2014} defines the order parameter such that $\phi_i=\pm1$ indicates presence of the phase $i$, and $\phi_i=0$ indicates absence.
	The matrix phase $\gamma$ exists where $\sum\phi_i=0$. This allows for multiple discrete precipitates of the same phase, without unphysical coalescence.
	Therefore the phase fractions $n_i=h(|\phi_i|)$ and $n_\gamma=1-\sum h(|\phi_i|)$.
	The KKS interface model \cite{Kim1999} assumes constant chemical potential through the interface, so
	\begin{align}
		\label{eqn:potcr}
		\tilde{\mu}_\ce{Cr} &= \frac{\partial f_\gamma}{\partial x_\ce{Cr}^\gamma}
		                     = \frac{\partial f_\delta}{\partial x_\ce{Cr}^\delta}
		                     = \frac{\partial f_\mu}{\partial x_\ce{Cr}^\mu}
		                     = \frac{\partial f_\ce{L}}{\partial x_\ce{Cr}^\ce{L}}\\
		\label{eqn:potnb}
		\tilde{\mu}_\ce{Nb} &= \frac{\partial f_\gamma}{\partial x_\ce{Nb}^\gamma}
		                     = \frac{\partial f_\delta}{\partial x_\ce{Nb}^\delta}
		                     = \frac{\partial f_\mu}{\partial x_\ce{Nb}^\mu}
		                     = \frac{\partial f_\ce{L}}{\partial x_\ce{Nb}^\ce{L}}
	\end{align}
	The pure phase compositions $\left(x_j^i\right)$ are determined by solving the parallel tangent construction constrained by the
	conservation of mass and equality of chemical potentials for each phase,
	
	\begin{align}
		0 &= x_\ce{Cr} - n_\gamma x_\ce{Cr}^\gamma - n_\delta x_\ce{Cr}^\delta - n_\mu x_\ce{Cr}^\mu - n_{\mathrm{L}}x_\ce{Cr}^{\mathrm{L}}\\
		0 &= x_\ce{Nb} - n_\gamma x_\ce{Nb}^\gamma - n_\delta x_\ce{Nb}^\delta - n_\mu x_\ce{Nb}^\mu - n_{\mathrm{L}}x_\ce{Nb}^{\mathrm{L}}\\
		0 &= \frac{\partial f_\gamma}{\partial x_\ce{Cr}^\gamma} - \frac{\partial f_\delta}{\partial x_\ce{Cr}^\delta}\\
		0 &= \frac{\partial f_\gamma}{\partial x_\ce{Nb}^\gamma} - \frac{\partial f_\delta}{\partial x_\ce{Nb}^\delta}\\
		0 &= \frac{\partial f_\gamma}{\partial x_\ce{Cr}^\gamma} - \frac{\partial f_\mu}{\partial x_\ce{Cr}^\mu}\\
		0 &= \frac{\partial f_\gamma}{\partial x_\ce{Ni}^\gamma} - \frac{\partial f_\mu}{\partial x_\ce{Ni}^\mu}\\
		0 &= \frac{\partial f_\gamma}{\partial x_\ce{Nb}^\gamma} - \frac{\partial f_\ce{L}}{\partial x_\ce{Nb}^\ce{L}}\\
		0 &= \frac{\partial f_\gamma}{\partial x_\ce{Ni}^\gamma} - \frac{\partial f_\ce{L}}{\partial x_\ce{Ni}^\ce{L}},
	\end{align}
	in which each partial derivative is evaluated at the pure phase composition $x_j^i$, not the system composition $x_j$.
	This set of eight equations should uniquely solve for the eight unknown pure compositions at each point,
	given that $x_\ce{Ni}^i = 1-x_\ce{Cr}^i-x_\ce{Nb}^i$.
	This solution is found using the GNU Scientific Library's multiroot solver, provided these eight equations and the
	Jacobian matrix defined by their partial derivatives with respect to $x_\ce{Cr}^\gamma$,
	                                                                     $x_\ce{Nb}^\gamma$,
	                                                                     $x_\ce{Cr}^\delta$,
	                                                                     $x_\ce{Nb}^\delta$,
	                                                                     $x_\ce{Cr}^\mu$,
	                                                                     $x_\ce{Ni}^\mu$,
	                                                                     $x_\ce{Nb}^\ce{L}$, and
	                                                                     $x_\ce{Ni}^\ce{L}$.\footnote{
	The system compositions $x_\ce{Cr}$ and $x_\ce{Nb}$ depend on $x_\ce{Cr}^i$ and $x_\ce{Nb}^i$; these ten values are stored as field variables.
	The parallel tangent solver uses the components most appropriate for each phase. Conversions are made using the constraint $\sum_j x_j^i=1$.
	}
	During the iterations, $x_\ce{Cr}$,
	                       $x_\ce{Nb}$,
	                       $\phi_\delta$,
	                       $\phi_\mu$, and
	                       $\phi_\ce{L}$ are held constant.
	
	The free energy density
	\begin{align}
		f(x,\phi,t) &= n_\gamma f_\gamma(x_\ce{Cr}^\gamma,x_\ce{Nb}^\gamma) + n_\delta f_\delta(x_\ce{Cr}^\delta,x_\ce{Nb}^\delta)
		                  + n_\mu f_\mu(x_\ce{Cr}^\mu,x_\ce{Ni}^\mu) + n_\ce{L}f_\ce{L}(x_\ce{Nb}^\ce{L},x_\ce{Ni}^\ce{L})\\\nonumber
		                 &+ \omega_\delta(\phi_\delta)^2(1-|\phi_\delta|)^2
		                  + \omega_\mu(\phi_\mu)^2(1-|\phi_\mu|)^2
		                  + \omega_\ce{L}(\phi_\ce{L})^2(1-|\phi_\ce{L}|)^2\\\nonumber
		                 &+ \alpha\sum\sum\phi_i^2\phi_j^2
	\end{align}
	
	Finally, the equations of motion are defined as
	\begin{align}
		\tilde{\mu}_\ce{Cr} &= \frac{\partial f_\gamma}{\partial x_\ce{Cr}^\gamma}\\
		\tilde{\mu}_\ce{Nb} &= \frac{\partial f_\gamma}{\partial x_\ce{Nb}^\gamma}\\
		\frac{\partial x_\ce{Cr}}{\partial t} &= V_m^2M_\ce{Cr}\nabla^2\tilde{\mu}_\ce{Cr}\\
		\frac{\partial x_\ce{Nb}}{\partial t} &= V_m^2M_\ce{Nb}\nabla^2\tilde{\mu}_\ce{Nb}\\
		\frac{\partial \phi_i}{\partial t} &= -L_i\left(\frac{\partial f}{\partial \phi_i} - \kappa_i\nabla^2\phi_i\right)\\
		\frac{\partial f}{\partial \phi_i} &= \sgn(\phi_i)h'(|\phi_i|)\left[f_i(x_\ce{Cr}^i,x_\ce{Nb}^i) - f_\gamma(x_\ce{Cr}^\gamma,x_\ce{Nb}^\gamma)\right]\\\nonumber
		                                   &+ 2\omega_i\phi_i\left(1-|\phi_i|\right)^2 - 2\omega_i\phi_i^2\sgn(\phi_i)\left(1-|\phi_i|\right)
		                                    + 4\alpha\phi_i\sum_{k>i}\phi_k^2.
	\end{align}
	The presence of absolute values in the free energy complicates the variational derivatives, and are not included in some places
	I would expect them. After some mucking about, I've decided to trust Zhou \emph{et al.} and implement the equations -- and
	take their partial derivatives -- as written.

	\appendix
		\begin{table}\centering
			\caption{Model parameters used in this work}
			\begin{tabular}{lll}\hline
				Parameter Description & Symbol & Value\\\hline
				Mesh resolution       & $\Delta x$              & \SI{5.0e-9}{\meter}\\
				Timestep              & $\Delta t$              & \SI{5.0e-7}{\second}\\
				Temperature           & $T$                     & \SI{870}{\degreeCelsius}\\
				Molar volume          & $V_m$                   & \SI{1.0e-5}{\cubic\meter/\mole}\\
				Triple penalty        & $\alpha$                & \SI{1.07e11}{\joule/\cubic\meter}\\
				Interfacial energy    & $\sigma_\delta
				                        =\sigma_\mu
				                        =\sigma_\ce{L}$     & \SI{1.01}{\joule/\square\meter}\\
				Gradient penalty      & $\kappa_\delta
				                        =\kappa_\mu
				                        =\kappa_\ce{L}$     & \SI{1.24e-8}{\joule/\meter}\\
				Mobility              & $M_\ce{Cr} = M_\ce{Nb}$ & \SI{2.42e-18}{\square\meter/\second}\\
				Mobility              & $L_\delta
				                        =L_\mu
				                        =L_\ce{L}$          & \SI{2.904e-11}{\square\meter/\newton/\second}\\
				Interface width       & $2\lambda$              & $7\Delta x$\\
				Well height           & $\omega_\delta
				                        =\omega_\mu
				                        =\omega_\ce{L}$     & $6.6 \sigma_\delta / 2\lambda$\\
				Well height           & $\omega_\delta
				                        =\omega_\mu
				                        =\omega_\ce{L}$     & \SI{1.9e8}{\joule/\cubic\meter}\\
				$\gamma$ curvature    & $C_\ce{Cr}^\gamma$      & \SI{2.6e4}{\joule/\mole}\\
				                      & $C_\ce{Nb}^\gamma$      & \SI{5.2e5}{\joule/\mole}\\
				$\delta$ curvature    & $C_\ce{Cr}^\delta$      & \SI{1.5e6}{\joule/\mole}\\
				                      & $C_\ce{Nb}^\delta$      & \SI{8.3e5}{\joule/\mole}\\
				$\mu$ curvature       & $C_\ce{Cr}^\mu$         & \SI{1.5e6}{\joule/\mole}\\
				                      & $C_\ce{Ni}^\mu$         & \SI{9.5e4}{\joule/\mole}\\
				Laves curvature       & $C_\ce{Cr}^\ce{L}$      & \SI{8.2e5}{\joule/\mole}\\
				                      & $C_\ce{Nb}^\ce{L}$      & \SI{9.5e4}{\joule/\mole}\\
				$\gamma$ composition  & $x_\ce{Cr}^{\gamma,e}$  & \SI{30.00}{\percent}\\
				                      & $x_\ce{Nb}^{\gamma,e}$  & \phantom{n}\SI{1.00}{\percent}\\
				$\delta$ composition  & $x_\ce{Cr}^{\delta,e}$  & \phantom{n}\SI{0.3125}{\percent}\\
				                      & $x_\ce{Nb}^{\delta,e}$  & \SI{24.375}{\percent}\\
				$\mu$ composition  & $x_\ce{Cr}^{\mu,e}$        & \phantom{n}\SI{5.00}{\percent}\\
				                   & $x_\ce{Nb}^{\mu,e}$        & \SI{48.75}{\percent}\\
				Laves composition  & $x_\ce{Nb}^{\ce{L},e}$  & \SI{28.75}{\percent}\\
				                   & $x_\ce{Ni}^{\ce{L},e}$  & \SI{38.75}{\percent}\\
				\hline
			\end{tabular}
		\end{table}
	
	\begin{thebibliography}{1}
		\bibitem{Kim1999} Kim, S. G.; Kim, W. T. and Suzuki, T. ``Phase-field model for binary alloys.'' \emph{Phys. Rev. E} \textbf{60} (1999) 7186--7197. DOI: 10.1103/PhysRevE.60.7186.

		\bibitem{Zhou2014} Zhou, N.; Lv, D.; Zhang, H.; McAllister, D.; Zhang, F.; Mills, M. and Wang, Y.
		                   ``Computer simulation of phase transformation and plastic deformation in IN718 superalloy: Microstructural evolution during precipitation.''
		                   \emph{Acta Mater.} \textbf{65} (2014) 270--286. DOI: 10.1016/j.actamat.2013.10.069.
	\end{thebibliography}
\end{document}
